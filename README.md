# sfm_mesa_convex_map
## リファクタリングしたプログラムの挙動が変わっていないか検証する
## 必要な機能は追加する
### feature/agent-turning
1. 不要な関数を削除(add_road_density_number)
1. 三叉路マップに合わせた機能を追加
    1. 自分の進行方向から斜め方向の壁に対して受ける反発力を追加
    1. 読みやすいように関数化
1. 直線上のマップから三叉路のマップに変更
    1. 必要と予想される変更箇所
        1. s_server_f_r_m.py
            1. 直線上のマップから三叉路のマップに変更(wall_arr)
            1. 避難所を通常の避難者と強引な避難者で分ける
        1. s_model.py
            1. 各エージェントの初期配置の変更
            1. 各エージェントの避難所を変更
            1. エージェントが重なり合わない関数を追加
        1. s_agent.py
            1. 壁からはみ出さないような関数を追加する
            1. 通常の避難者または強引な避難者が通る中間目的地を設定する．
1. 検証(現在作業中)
    1. 比較対象のプログラム
        1. s_server_repul.py
        1. s_model_repul.py
        1. s_agent_repul.py (変数名がalphaではなくf_repul_ratioであることに注意)

#### 今後の改善予定（ToDo）
- s_model.pyにハードコーディングされている箇所(避難所の場所や初期配置の範囲など)があるためそれらを引数で渡すようにする．
- s_model.pyも含めて関数名が分かりにくいところがあるのでリファクタリングする
- SharedParamsクラスの変数in_target_dをどうするか検討(使うか使わないか)
- グラフの作成を一回の実行で完了させる(作業中)

#### 次回作業開始するためのメモ
- 強引な避難者が初期配置範囲外で生成されている気がするので要check 
    - ok
 - max_f_rは設定されていなかった？(もしくは通常の避難者と同じであったか) 
    - max_f_rは通常の避難者と同じだったと仮定する
- 避難者同士に働く反発力について要check(リファクタリング後の現状、通常の避難者と強引な避難者に働く反発力の計算方法は同じになっている)
    - 今後のことを考えると通常と強引な避難者のすべての組み合わせ(4通り)で計算方法を変えるコードにした方が良いかもしれない　
        - ForcefulHumanについて、specs,hspecのモードで切り替えることにした．
            - (毎回関数で呼び出しているため計算負荷が高くなるかも．．．？)
    - 通常，強引に働く人同士の反発力についてalphaの値を加味した反発力計算に変更する
        - alphaをHumanVar, ForcefulHumanVarに追加する(ので，server, model, agentに追加要素)
- 再現するために機能を追加 (リファクタリング後は削除するかもしれない)
    - 具体的な変数や関数(s_agent.py)
        - HumanまたはForcefulHuman自体にtarget_idを導入
        - target_update()を導入
        - reset_target()を導入
- obs_agentのマップを直線上のマップから三叉路のマップに変更する(マップを気にしなければ避難者の動き自体は確認できる)
- tmp.yamlの名前を変更する
    - human_specs.yamlに変更
- tmp.yamlにtimestampを記録する
    - ok
- 本来ForcefulHumanが持っていない(正確にいうとfhspecs)変数のvision変数を参照していたため、原因を調査
    - fhspcesがForcefulHumanSpecsのインスタンス変数であるところがHumanSpecsのインスタンス変数になっていた
        - fhspecsをForcefulHumanSpecsのインスタンス変数にする
            - ok
        - visionやdt,in_target_dをどうするか考える
         - SharedParamsクラスの変数としてまとめて入れる
            - in_target_d: 使われていない(おそらく目的地とエージェントの距離がこの値以下だったらゴールした判定に使う値) 今後使うかも
            - ok
(時間があったら)
- forceful_time.csvについて一列ずつずれているので修正する
    - ok.(index=Falseで問題解決)
- s_model.pyのcheck_f_parameter()についてalphaの値の違いが判定条件に入っていないので修正する

## グラフの作成方法(避難完了率と時間のグラフ)
1. gather_eva_time_to_csv.pyを必要な箇所コードを書き換えて保存(その計算機本体に保存されている同じ属性の全てのエージェントの避難時間を共通領域に保存する)
2. gather_eva_time.shを必要な箇所コードを書き換えて保存、実行する(1.を複数の計算機に対してまとめて実行する)
3. merge_and_cal_ave_time_refact.pyを必要な箇所コードを書き換えて保存、実行する(通常の避難者の人数ごとに避難完了率と時間の関係をグラフにし、共通領域に保存する)